# Langkah-langkah Deployment ke Production

Panduan lengkap untuk meng-deploy aplikasi Online Library Management System ke production environment.

## Prerequisites

Sebelum memulai, pastikan Anda memiliki:
- [ ] Server dengan PHP >= 8.2
- [ ] MySQL/MariaDB database server
- [ ] Composer terinstall
- [ ] Node.js dan NPM terinstall
- [ ] Web server (Apache/Nginx) dikonfigurasi
- [ ] Domain name dan SSL certificate (untuk HTTPS)
- [ ] SSH access ke server

## 1. Persiapan Server

### 1.1 Update System Packages

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 1.2 Install PHP dan Extensions

```bash
# Ubuntu/Debian
sudo apt install php8.2 php8.2-cli php8.2-fpm php8.2-mysql php8.2-mbstring \
    php8.2-xml php8.2-curl php8.2-zip php8.2-gd php8.2-bcmath -y

# CentOS/RHEL
sudo yum install php82 php82-php-cli php82-php-fpm php82-php-mysqlnd \
    php82-php-mbstring php82-php-xml php82-php-curl php82-php-zip \
    php82-php-gd php82-php-bcmath -y
```

### 1.3 Install Composer

```bash
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
sudo chmod +x /usr/local/bin/composer
```

### 1.4 Install Node.js dan NPM

```bash
# Menggunakan NodeSource repository (recommended)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# Atau menggunakan nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 20
nvm use 20
```

## 2. Setup Database

### 2.1 Buat Database dan User

```sql
-- Login ke MySQL
mysql -u root -p

-- Buat database
CREATE DATABASE library_app CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Buat user untuk aplikasi
CREATE USER 'library_user'@'localhost' IDENTIFIED BY 'strong_password_here';

-- Berikan privileges
GRANT ALL PRIVILEGES ON library_app.* TO 'library_user'@'localhost';
FLUSH PRIVILEGES;

-- Exit
EXIT;
```

### 2.2 Backup Database (jika ada data existing)

```bash
mysqldump -u root -p library_app > backup_$(date +%Y%m%d_%H%M%S).sql
```

## 3. Deploy Aplikasi

### 3.1 Clone Repository ke Server

```bash
# Buat direktori untuk aplikasi
sudo mkdir -p /var/www/library-app
sudo chown -R $USER:$USER /var/www/library-app

# Clone repository
cd /var/www/library-app
git clone <repository-url> .

# Atau jika sudah ada, pull latest changes
git pull origin master
```

### 3.2 Install Dependencies

```bash
cd /var/www/library-app

# Install PHP dependencies (production mode)
composer install --optimize-autoloader --no-dev

# Install Node dependencies
npm install

# Build assets untuk production
npm run build
```

### 3.3 Setup Environment

```bash
# Copy .env.example ke .env
cp .env.example .env

# Generate application key
php artisan key:generate
```

### 3.4 Konfigurasi .env untuk Production

Edit file `.env` dengan konfigurasi production:

```env
APP_NAME="Online Library"
APP_ENV=production
APP_KEY=base64:... # Generated by key:generate
APP_DEBUG=false
APP_URL=https://yourdomain.com

LOG_CHANNEL=stack
LOG_LEVEL=error

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=library_app
DB_USERNAME=library_user
DB_PASSWORD=strong_password_here

SESSION_DRIVER=database
SESSION_LIFETIME=120

CACHE_STORE=database
QUEUE_CONNECTION=database

# Sanctum Configuration (untuk API)
SANCTUM_STATEFUL_DOMAINS=yourdomain.com,www.yourdomain.com
```

### 3.5 Jalankan Migration dan Seeder

```bash
# Jalankan migration
php artisan migrate --force

# Jalankan seeder untuk data awal
php artisan db:seed --class=DatabaseSeeder

# Atau jika ingin fresh start
php artisan migrate:fresh --seed --force
```

### 3.6 Setup Storage Link

```bash
# Buat symbolic link untuk storage
php artisan storage:link
```

### 3.7 Set Permissions

```bash
# Set ownership
sudo chown -R www-data:www-data /var/www/library-app

# Set permissions untuk storage dan cache
sudo chmod -R 775 /var/www/library-app/storage
sudo chmod -R 775 /var/www/library-app/bootstrap/cache

# Set permissions untuk file lainnya
sudo find /var/www/library-app -type f -exec chmod 644 {} \;
sudo find /var/www/library-app -type d -exec chmod 755 {} \;
```

## 4. Konfigurasi Web Server

### 4.1 Apache Configuration

Buat file `/etc/apache2/sites-available/library-app.conf`:

```apache
<VirtualHost *:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    DocumentRoot /var/www/library-app/public

    <Directory /var/www/library-app/public>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/library-app_error.log
    CustomLog ${APACHE_LOG_DIR}/library-app_access.log combined
</VirtualHost>
```

Aktifkan site dan mod_rewrite:

```bash
sudo a2ensite library-app.conf
sudo a2enmod rewrite
sudo systemctl restart apache2
```

### 4.2 Nginx Configuration

Buat file `/etc/nginx/sites-available/library-app`:

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com www.yourdomain.com;
    root /var/www/library-app/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

Aktifkan configuration:

```bash
sudo ln -s /etc/nginx/sites-available/library-app /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

## 5. Setup SSL dengan Let's Encrypt

### 5.1 Install Certbot

```bash
# Ubuntu/Debian
sudo apt install certbot python3-certbot-nginx -y
# atau untuk Apache
sudo apt install certbot python3-certbot-apache -y
```

### 5.2 Generate SSL Certificate

```bash
# Untuk Nginx
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# Untuk Apache
sudo certbot --apache -d yourdomain.com -d www.yourdomain.com
```

### 5.3 Auto-renewal

Certbot akan otomatis setup auto-renewal. Test dengan:

```bash
sudo certbot renew --dry-run
```

## 6. Optimasi untuk Production

### 6.1 Cache Configuration

```bash
# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache

# Cache events (jika ada)
php artisan event:cache
```

### 6.2 Optimize Autoloader

```bash
composer dump-autoload --optimize --classmap-authoritative
```

### 6.3 Setup Queue Worker (jika menggunakan queue)

```bash
# Install supervisor
sudo apt install supervisor -y

# Buat config file
sudo nano /etc/supervisor/conf.d/laravel-worker.conf
```

Isi file dengan:

```ini
[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/library-app/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/library-app/storage/logs/worker.log
stopwaitsecs=3600
```

Start supervisor:

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start laravel-worker:*
```

### 6.4 Setup Scheduled Tasks (Cron)

```bash
# Edit crontab
sudo crontab -e -u www-data

# Tambahkan baris berikut
* * * * * cd /var/www/library-app && php artisan schedule:run >> /dev/null 2>&1
```

## 7. Security Hardening

### 7.1 Firewall Configuration

```bash
# Install UFW (Ubuntu)
sudo apt install ufw -y

# Allow SSH, HTTP, HTTPS
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Enable firewall
sudo ufw enable
```

### 7.2 Fail2Ban Setup (optional)

```bash
sudo apt install fail2ban -y
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 7.3 Security Headers

Tambahkan di Nginx config atau Apache .htaccess:

```nginx
# Nginx
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
```

### 7.4 Disable Directory Listing

```bash
# Di .htaccess (Apache) atau Nginx config
# Apache sudah otomatis di Laravel
# Nginx: tambahkan di server block
autoindex off;
```

## 8. Monitoring dan Logging

### 8.1 Setup Log Rotation

Buat file `/etc/logrotate.d/laravel`:

```
/var/www/library-app/storage/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
}
```

### 8.2 Monitor Application

```bash
# Check application status
php artisan about

# Check queue status
php artisan queue:monitor

# View logs
tail -f storage/logs/laravel.log
```

## 9. Backup Strategy

### 9.1 Database Backup Script

Buat file `/usr/local/bin/backup-library-db.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/library-app"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="library_app"
DB_USER="library_user"
DB_PASS="your_password"

mkdir -p $BACKUP_DIR

mysqldump -u $DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/db_backup_$DATE.sql.gz

# Hapus backup lebih dari 30 hari
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +30 -delete

echo "Backup completed: db_backup_$DATE.sql.gz"
```

Buat executable:

```bash
sudo chmod +x /usr/local/bin/backup-library-db.sh
```

### 9.2 Setup Automated Backup

```bash
# Tambahkan ke crontab
sudo crontab -e

# Backup setiap hari jam 2 pagi
0 2 * * * /usr/local/bin/backup-library-db.sh
```

### 9.3 Backup Files

```bash
# Backup storage dan uploads
tar -czf /var/backups/library-app/files_backup_$(date +%Y%m%d).tar.gz \
    /var/www/library-app/storage/app/public
```

## 10. Testing Production Setup

### 10.1 Test Checklist

- [ ] Homepage dapat diakses
- [ ] Login sebagai admin berfungsi
- [ ] CRUD books berfungsi
- [ ] API endpoints dapat diakses
- [ ] Google Books import berfungsi
- [ ] About page dapat diakses dan di-edit
- [ ] SSL certificate valid
- [ ] Error pages (404, 500) ditampilkan dengan benar
- [ ] Logs berfungsi
- [ ] Backup script berjalan

### 10.2 Performance Testing

```bash
# Install Apache Bench atau gunakan tools lain
ab -n 1000 -c 10 https://yourdomain.com/

# Atau gunakan tools online seperti:
# - GTmetrix
# - Google PageSpeed Insights
# - Pingdom
```

## 11. Maintenance Commands

### 11.1 Update Application

```bash
cd /var/www/library-app

# Pull latest changes
git pull origin master

# Install/update dependencies
composer install --optimize-autoloader --no-dev
npm install
npm run build

# Run migrations
php artisan migrate --force

# Clear and rebuild cache
php artisan optimize:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### 11.2 Troubleshooting

```bash
# Clear all caches
php artisan optimize:clear

# Check application status
php artisan about

# View recent logs
tail -n 100 storage/logs/laravel.log

# Check queue status
php artisan queue:work --once

# Test database connection
php artisan tinker
>>> DB::connection()->getPdo();
```

## 12. Post-Deployment Checklist

- [ ] Semua environment variables dikonfigurasi dengan benar
- [ ] Database migration berhasil
- [ ] SSL certificate aktif dan valid
- [ ] Web server berjalan dengan benar
- [ ] Permissions file dan folder sudah benar
- [ ] Cache sudah di-build
- [ ] Queue worker berjalan (jika digunakan)
- [ ] Scheduled tasks setup (cron)
- [ ] Backup strategy sudah diimplementasi
- [ ] Monitoring dan logging aktif
- [ ] Security headers dikonfigurasi
- [ ] Firewall dikonfigurasi
- [ ] Admin user dapat login
- [ ] Semua fitur utama berfungsi
- [ ] API endpoints dapat diakses
- [ ] Error handling berfungsi dengan baik

## 13. Support dan Maintenance

### 13.1 Regular Maintenance Tasks

**Harian:**
- Monitor error logs
- Check disk space
- Verify backups

**Mingguan:**
- Review security logs
- Update dependencies (jika perlu)
- Performance monitoring

**Bulanan:**
- Full system backup
- Security updates
- Performance optimization review

### 13.2 Update Dependencies

```bash
# Update Composer packages
composer update --no-dev

# Update NPM packages
npm update

# Rebuild assets
npm run build

# Clear cache
php artisan optimize:clear
php artisan optimize
```

## Troubleshooting Common Issues

### Issue: 500 Internal Server Error

```bash
# Check logs
tail -f storage/logs/laravel.log

# Check permissions
sudo chown -R www-data:www-data storage bootstrap/cache
sudo chmod -R 775 storage bootstrap/cache

# Clear cache
php artisan optimize:clear
```

### Issue: Database Connection Error

```bash
# Test connection
php artisan tinker
>>> DB::connection()->getPdo();

# Check .env configuration
cat .env | grep DB_
```

### Issue: Permission Denied

```bash
# Fix ownership
sudo chown -R www-data:www-data /var/www/library-app

# Fix permissions
sudo find /var/www/library-app -type d -exec chmod 755 {} \;
sudo find /var/www/library-app -type f -exec chmod 644 {} \;
sudo chmod -R 775 storage bootstrap/cache
```

## Additional Resources

- [Laravel Deployment Documentation](https://laravel.com/docs/deployment)
- [Laravel Security Best Practices](https://laravel.com/docs/security)
- [Server Management Best Practices](https://laravel.com/docs/configuration#environment-configuration)

---

**Catatan Penting:**
- Selalu backup database sebelum melakukan update
- Test di staging environment terlebih dahulu
- Monitor logs secara berkala
- Keep dependencies updated untuk security patches
- Gunakan strong passwords untuk database dan aplikasi

